#############################################################################
### Plot statistics of the OpenStack VMs from the OpenStack usage command ###
#############################################################################
# Read in .csv file generated by OpenStack
#openstack_usage_data_month <- read.csv(file="/path/to/openstack/generated/csv/file",
#                                        header=TRUE,
#                                        as.is=TRUE,
#                                        sep=",")

openstack_usage_data_month <- read.csv(file="/home/mhanussek/openstack_usage_information/usage_openstack/usage_2017/openstack_usage_december_2017.csv",
                                       header=TRUE,
                                       as.is=TRUE,
                                       sep=",")
number_of_projects <- nrow(openstack_usage_data_month)                    # Get number of projects as iterator
project_names <- c()                                                      # Initialize vector of project names
ram_data <- c()                                                           # Initialize vector of ram values
servers <- c()                                                            # Initialize vector of server numbers
cpu_data <- c()                                                           # Initialize vector of CPU values
disk_data <- c()                                                          # Initialize vector of disk values

options("scipen"=100)
# # Iterate over the projects and parse out the values
 for (project in 1:number_of_projects){
   project_names <- c(project_names, paste(toString(openstack_usage_data_month[project,1]),"(",openstack_usage_data_month[project,2],")"))
   servers <- c(servers, openstack_usage_data_month[project,2])
   ram_data <- c(ram_data, openstack_usage_data_month[project,3]/1000)     # RAM data values has to be divided by 1000 as they are given in MB and we want them in GB
   cpu_data <- c(cpu_data, openstack_usage_data_month[project,4])
   disk_data <- c(disk_data, openstack_usage_data_month[project,5])
 }

# # Convert the read in .csv file from table to dataframe
openstack_usage_info_dataframe <- data.frame(group = project_names, RAM = ram_data, DISK = disk_data, CPU = cpu_data)
# 
# # Function that calculates the proportion of the bars where the maximum value is used as normalize level
funProp <- function(openstack_usage_info_dataframeCol) {
  openstack_usage_info_dataframe[, openstack_usage_info_dataframeCol]/max(openstack_usage_info_dataframe[, openstack_usage_info_dataframeCol])
}

# # Calculate proportions (as the disk value will orientate on the same scale as RAM, it has to be divided by the max RAM value)
openstack_usage_info_dataframe$RAM.prop <- funProp("RAM")
openstack_usage_info_dataframe$DISK.prop <- openstack_usage_info_dataframe[, "DISK"]/max(openstack_usage_info_dataframe[, "RAM"])
openstack_usage_info_dataframe$CPU.prop <- funProp("CPU")

# # Generate labels for the left y-axes (RAM/Disk) and for the right y-axes (CPU) 
ram_disk_axis_labs <- pretty(seq(0, max(openstack_usage_info_dataframe$RAM), length.out = 10))
cpu_axis_labs <- pretty(seq(0, max(openstack_usage_info_dataframe$CPU), length.out = 10))
 
# # Generate positions of the ram/disk and cpu labels 
ram_disk_axis_at <- ram_disk_axis_labs/max(openstack_usage_info_dataframe$RAM)
cpu_axis_at <- cpu_axis_labs/max(openstack_usage_info_dataframe$CPU)
 
# # Generate barplot (without y-axes)
barplot(t(as.matrix(openstack_usage_info_dataframe[, c("RAM.prop", "DISK.prop", "CPU.prop")])),
        beside = TRUE, yaxt = "n", names.arg = openstack_usage_info_dataframe$group,
        ylim=c(0, max(c(ram_disk_axis_at, cpu_axis_at))), ylab = "RAM/Disk Hours [GB]", col = topo.colors(3), cex.names = 0.65, las = 2)
legend("topright", legend = c("RAM","Disk","CPU"), inset = .01, fill = topo.colors(3), cex=0.8)
 
# # Add left y-axes to the generated plot (RAM/disk)
axis(2, at = ram_disk_axis_at, labels = ram_disk_axis_labs)
 
# # Add right y-axes to the generated plot (CPU)
axis(4, at = cpu_axis_at, labels = cpu_axis_labs)

# # Add y-axes description of the right  y-axes (CPU)
mtext(side = 4, line = -1, 'CPU Hours')



##########################################################################
### Plot statistics of the OpenStack VMs from the hypervisors directly ###
##########################################################################

# Read in .txt file generated by a Bash script on the OS controller node to measure the CPU and memory usage directly from the hypervisor 
 openstack_usage_data_month_hypervisor <- read.table(file="/path/to/generated/hypervisor/stats/txt/file",
                                        header=TRUE,
                                        fill = TRUE,
                                        as.is = TRUE,
                                        row.names = NULL,
                                        na.strings=c("","NA"),
                                        sep=" ")

# # Generate vector of the VM IDs only with one entry for each ID
 unique_vmids <- unique(openstack_usage_data_month_hypervisor$VMID)
 
# # Filter out NA entries
 unique_vmids <- unique_vmids[!is.na(unique_vmids)]
 
# # Iterate over the whole data frame and get the CPU values for each VM ID
 for (unique_vmid in 1:length(unique_vmids)){
   vmid <- openstack_usage_data_month_hypervisor[complete.cases(openstack_usage_data_month_hypervisor[openstack_usage_data_month_hypervisor$VMID %in% unique_vmids[unique_vmid],]),]
   
   # Check if the vector does not only consists of NA values (might be the case for shut down VMs before the instance list on the osm03 has been refreshed)
   if (nrow(vmid) != 0){
     vmid_sub <- vmid$CPU_USAGE...[seq(1, length(vmid$CPU_USAGE...), 5)] # Take only every fifth value (same as every 5 min) (plot will be mor clearly)
     vmid_sub[is.na(vmid_sub)] <- 0                                      # Replace NA's through 0
     par(ps = 12, cex = 1, cex.main = 0.8)                               # Set font size of the main title
     
     # plot line plot of the extracted CPU values for each VM
     plot(vmid_sub, type="n", 
          main =paste(openstack_usage_data_month_hypervisor$PROJECT_NAME[1], "\n", unique_vmids[unique_vmid]),
          xlab = "timesteps (5min)",
          ylab = "CPU utilization [%]")
     lines(vmid_sub)
     } else{
         print("Contains only NAs")
     }
 }
# 
# # Iterate over the whole data frame and get the RAM values for each VM ID
for (unique_vmid in 1:length(unique_vmids)){
  vmid <- openstack_usage_data_month_hypervisor[complete.cases(openstack_usage_data_month_hypervisor[openstack_usage_data_month_hypervisor$VMID %in% unique_vmids[unique_vmid],]),]

#   # Check if the vector does not only consists of NA values (might be the case for shut down VMs before the instance list on the osm03 has been refreshed)
  if (nrow(vmid) != 0){
    vmid_sub <- vmid$MEM_USAGE...[seq(1, length(vmid$MEM_USAGE...), 20)] # Take only every twentyth value (same as every 20 min) (plot will be mor clearly)
    vmid_sub[is.na(vmid_sub)] <- 0                                       # Replace NA's through 0
    par(ps = 12, cex = 1, cex.main = 0.8)                                # Set font size of the main title

    # plot line plot of the extracted RAM values for each VM
    plot(vmid_sub, type="n",
         main =paste(openstack_usage_data_month_hypervisor$PROJECT_NAME[1], "\n", unique_vmids[unique_vmid]),
         xlab = "timesteps (5min)",
         ylab = "RAM utilization [%]")
    lines(vmid_sub)
  } else{
    print("Contains only NAs")
  }
}

