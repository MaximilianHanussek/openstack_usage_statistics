##########################################################################
### Plot statistics of the OpenStack VMs from the hypervisors directly ###
##########################################################################

args <- commandArgs(trailingOnly = TRUE)
filepath <- args[1]
outputpath <- args[2]

# Read in .txt file generated by a Bash script on the OS controller node to measure the CPU and memory usage directly from the hypervisor 
openstack_usage_data_month_hypervisor <- read.table(file=filepath,
                                                    header=TRUE,
                                                    fill = TRUE,
                                                    as.is = TRUE,
                                                    row.names = NULL,
                                                    na.strings=c("","NA"),
                                                    sep=" ")

# # Generate vector of the VM IDs only with one entry for each ID
unique_vmids <- unique(openstack_usage_data_month_hypervisor$VMID)

# # Filter out NA entries
unique_vmids <- unique_vmids[!is.na(unique_vmids)]

# # Iterate over the whole data frame and get the CPU values for each VM ID
for (unique_vmid in 1:length(unique_vmids)){
  vmid <- openstack_usage_data_month_hypervisor[complete.cases(openstack_usage_data_month_hypervisor[openstack_usage_data_month_hypervisor$VMID %in% unique_vmids[unique_vmid],]),]
  
  # Check if the vector does not only consists of NA values (might be the case for shut down VMs before the instance list on the osm03 has been refreshed)
  if (nrow(vmid) != 0){
    vmid_sub <- vmid$CPU_USAGE...[seq(1, length(vmid$CPU_USAGE...), 5)] # Take only every fifth value (same as every 5 min) (plot will be mor clearly)
    vmid_sub[is.na(vmid_sub)] <- 0                                      # Replace NA's through 0
    par(ps = 12, cex = 1, cex.main = 0.8)                               # Set font size of the main title
    
    # plot line plot of the extracted CPU values for each VM
    plot(vmid_sub, type="n", 
         main =paste(openstack_usage_data_month_hypervisor$PROJECT_NAME[1], "\n", unique_vmids[unique_vmid]),
         xlab = "timesteps (5min)",
         ylab = "CPU utilization [%]")
    lines(vmid_sub)
  } else{
    print("Contains only NAs")
  }
}
# 
# # Iterate over the whole data frame and get the RAM values for each VM ID
for (unique_vmid in 1:length(unique_vmids)){
  vmid <- openstack_usage_data_month_hypervisor[complete.cases(openstack_usage_data_month_hypervisor[openstack_usage_data_month_hypervisor$VMID %in% unique_vmids[unique_vmid],]),]
  
  #   # Check if the vector does not only consists of NA values (might be the case for shut down VMs before the instance list on the osm03 has been refreshed)
  if (nrow(vmid) != 0){
    vmid_sub <- vmid$MEM_USAGE...[seq(1, length(vmid$MEM_USAGE...), 20)] # Take only every twentyth value (same as every 20 min) (plot will be mor clearly)
    vmid_sub[is.na(vmid_sub)] <- 0                                       # Replace NA's through 0
    par(ps = 12, cex = 1, cex.main = 0.8)                                # Set font size of the main title
    
    # plot line plot of the extracted RAM values for each VM
    plot(vmid_sub, type="n",
         main =paste(openstack_usage_data_month_hypervisor$PROJECT_NAME[1], "\n", unique_vmids[unique_vmid]),
         xlab = "timesteps (5min)",
         ylab = "RAM utilization [%]")
    lines(vmid_sub)
  } else{
    print("Contains only NAs")
  }
}
